<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <title>Pairs Trading</title>
    <!-- Plotly.js for interactive charts -->
    <div class="author-info mb-4">
        <small class="text-muted">
            Created by <strong>Xuanru Li , Xingjian Yin</strong> | Duke University Financial Technology | 533
            <a href="https://youtu.be/zB0wL_t-Nos" target="_blank" class="text-decoration-none">
                <i class="bi bi-youtube"></i> Watch demo video
            </a>
        </small>
    </div>
    <script src="https://cdn.plot.ly/plotly-2.26.2.min.js"></script>
    <!-- DataTables for interactive tables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #343a40;
        }
        .chart-container {
            height: 500px;
            margin-bottom: 30px;
        }
        .stats-card {
            background-color: #f1f8ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .tab-pane {
            padding: 20px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        #slider {
            width: 300px;
            overflow: hidden;
            border: 1px solid #ccc;
          }
          #slider-content {
            display: flex;
            transition: transform 0.4s ease;
            width: 900px; /* 3个子项，每项300px */
          }
          .slide {
            min-width: 300px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            background: #f0f0f0;
            border-right: 1px solid #ddd;
          }
          .controls {
            margin-top: 10px;
          }
    </style>
</head>
<body>
        <div class="container mt-4">
            <h1 class="mb-4">Pairs Trading Strategy Dashboard</h1>
            <p class="lead">Analysis and performance of LEVI-MHK pair trading strategy</p>
            <div class="container-fluid bg-light p-4 mb-4 rounded">
                <h2 class="mb-3">Pair Selection Analysis</h2>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mt-3">
                            <h5>Our Approach:</h5>
                            <p>We implemented a two-stage selection process:</p>
                            <ol>
                                <li><strong>Hierarchical Clustering:</strong>1. We use single linkage and only apply first layer for clustering to find closest pair. Specifically, minimum distance between any two points in the two clusters. Unlike K-Means, it does not require the number of clusters to be specified in advance.
                                    <br>2. After that, we apply a min heap data structure to find top 50 most "lease" closest pair, the reason is that if we use max heap, all the 50 pairs are the same company or same asset. Hieratical clustering garuantee us even it's least similar pairs in most similar pairs, it's still close enough. Actually, we can find some typical pairs like "V vs MA" with this method to prove our method's efficiency</li>
                                <li><strong>Cointegration Verification:</strong>1. We apply cointegration and find 35+ potential pairs, by checking with ADF test that if the log spread is stationary for pairs.
                                <br>2. Most of pairs are very similar assets or same company's different class stock, we apply some fundemental approach (choose related company when considering their main business). For example, LEVI is a premium clothing company while MHK is a flooring manufacture company. They are all in regular comsumption company and should in certain extent grow together when macro factor like dropping interest rates and increasing Gini coefficient.</li>
                            </ol>
                            <p>1. We use hieratical clustering to from all the US stocks market to find n = 2 pairs, every pair are closest to each other in terms of historical price
                                <br>2. After that, we find about 1800 pairs of potential match, then we do cointegration to between them and find over 35+ potential pairs
                                <br> 3. After that, we lock in three pairs: "LEVI" vs "MHK", "SYF" vs "COF", "V" vs "MA</p>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <!-- Pair Validation Table moved here to replace the chart -->
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Cointegration Test Results</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Top pairs tested for cointegration, sorted by cointegration score:</p>
                                <div class="table-responsive">
                                    <table id="validation-table" class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Stock 1</th>
                                                <th>Stock 2</th>
                                                <th>Cointegration Score</th>
                                                <th>p-value</th>
                                                <th>Is Cointegrated</th>
                                            </tr>
                                        </thead>
                                        <tbody id="validation-body">
                                            <!-- Will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid bg-light p-4 mb-4 rounded">
                    <h2 class="mb-3">Data Preparation & Transformation</h2>
                    <div class="row">
                        <div class="col-md-7">
                            <h4 class="mb-3">Log Transformation for Spread</h4>
                            <p class="mb-4">We use log spread when checking the spread between two pairs. The reason is that log spread is more stable and it's better to visualize that certain pairs have stable relationships in their differences.</p>
                            <p>Benefits of log transformation:</p>
                            <ul>
                                <li><strong>Improved Stationarity:</strong> Log transformation often helps achieve more stable statistical properties in price series</li>
                                <li><strong>Better Normalization:</strong> Creates more symmetrical distribution of spread values</li>
                                <li><strong>Ratio Interpretation:</strong> Log differences can be interpreted as percentage changes rather than absolute differences</li>
                                <li><strong>Enhanced Pattern Recognition:</strong> Makes recurring patterns in the spread more consistent and identifiable</li>
                            </ul>
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Figure 1: Spread after Log Transform</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="/picture/image.png" alt="Spread after log transform" class="img-fluid rounded" onerror="this.onerror=null; this.src='https://via.placeholder.com/600x400?text=Log+Transform+Visualization';">
                                    <p class="mt-3 text-muted small">The log-transformed spread provides clearer mean-reversion signals compared to raw price differences</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid bg-light p-4 mb-4 rounded">
                    <h2 class="mb-3">Trading Strategy</h2>
                    <div class="row">
                        <div class="col-md-12">
                            <h4 class="mb-3">Hybrid Strategy Approach</h4>
                            <p class="mb-4">Our strategy <strong>combines regular pairs trading mean reversion with momentum filtering (trend following)</strong>. This hybrid approach allows us to adapt to changing market conditions and exploit additional profit opportunities.</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Mean Reversion Component</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>Traditional pairs trading based on statistical reversion to the mean:</p>
                                            <ul>
                                                <li>Trade initiation when Z-score exceeds ±1.5</li>
                                                <li>Position closing when Z-score approaches 0</li>
                                                <li>Simultaneous long-short positions to maintain market neutrality</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Trend Following Component</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>Temporary shift to trend following when macro factors favor a single stock:</p>
                                            <ul>
                                                <li>Trend measurement using multiple moving averages:
                                                    <pre class="bg-light p-2 rounded"><code>data[ticker].rolling(10).mean() > data[ticker].rolling(30).mean()) & 
                (data[ticker].rolling(5).mean() > data[ticker].rolling(10).mean())</code></pre>
                                                </li>
                                                <li>Strategy switching conditions:
                                                    <ul>
                                                        <li>Switch to trend following when: <code>ticker1_strong_up and not ticker2_strong_up</code> or <code>ticker2_strong_up and not ticker1_strong_up</code></li>
                                                        <li>End trend following when: <code>ticker1_strong_up and ticker2_strong_up</code> (both stocks showing strength)</li>
                                                    </ul>
                                                </li>
                                                <li>Intraday approach with next-day closing to focus on short-term momentum</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-4">
                                <h5><i class="bi bi-info-circle"></i> Strategy Rationale</h5>
                                <p>Some macroeconomic factors may suddenly benefit one company within the pair. In such cases, we close our pairs trading position and switch to trend following (long the stronger trending stock). This intraday approach closes positions the next day, as our main focus remains on pairs trading while trend following captures short-term momentum.</p>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="strategy-explanation mb-4 p-3 border rounded bg-light">
                        <h4>Z-Score and Trading Signals</h4>
                        <p><strong>Strategy Overview:</strong> Z-score standardizes the spread deviation from its mean. We use a rolling window (window=len(train_data//2)) to dynamically adjust the Z-score calculation, significantly enhancing the strategy's responsiveness to current market conditions.</p>
                        
                        <div class="row mt-3">
                            <div class="col-md-7">
                                <h5 class="mb-3">Trading Signal Generation</h5>
                                <p>We made trades every day as long as there is a trading signal. Our signal generation uses dynamic thresholds:</p>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Z-score threshold for spread</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>When there is no active strategy and close action, we measure the z-score of log spread using rolling windows with (windows=len(train_data//2)) to better reflect current spread dynamics. This <strong>significantly</strong> enhances our strategy because it absorbs current market conditions.</p>
                                        
                                        <ul class="mb-3">
                                            <li><strong>Entry Signal (Pairs Trading):</strong>
                                                <pre class="bg-light p-2 rounded"><code>current_zscore > 1.5 or current_zscore < -1.5</code></pre>
                                                <p>We short the overvalued stock and long the undervalued stock based on position sizing calculations.</p>
                                            </li>
                                            <li><strong>Exit Signal (Pairs Trading):</strong>
                                                <pre class="bg-light p-2 rounded"><code>abs(current_zscore) < 0.5</code></pre>
                                                <p>We close all previous cumulative positions, which generally results in significant profit when the exit signal is triggered.</p>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Trading Execution</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            <li><strong>Z-Score</strong> - Represents how many standard deviations the log spread is from its historical mean</li>
                                            <li><strong>Trading Signals</strong> - Entry signals occur at Z-score thresholds of ±1.5, exit signals when Z-score approaches zero</li>
                                            <li><strong>Hybrid Approach</strong> - Strategy switches to trend following when one stock shows strong momentum (10-day MA > 30-day MA and 5-day MA > 10-day MA)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-5">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Figure 2: Test Results for LEVI vs MHK</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <img src="/picture/image2.png" alt="Test results for LEVI vs MHK" class="img-fluid rounded" onerror="this.onerror=null; this.src='https://via.placeholder.com/600x400?text=Z-Score+Trading+Signals';">
                                        <p class="mt-3 text-muted small">Blue stars in the Z-score chart indicate when we hit exit signals for pairs trading, typically resulting in profit realization.</p>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success mt-3">
                                    <h6><i class="bi bi-graph-up"></i> Performance Insight</h6>
                                    <p class="mb-0">The dynamic Z-score calculation with rolling window approach improved our Sharpe ratio by 18% compared to using static lookback periods, by better adapting to changing market volatility.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="container-fluid bg-light p-4 mb-4 rounded">
                        <h2 class="mb-3">General Features & Improvements</h2>
                        
                        <div class="row">
                            <!-- Understanding for Mixed Strategy -->
                            <div class="col-md-6">
                                <div class="card mb-4 h-100">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Understanding the Mixed Strategy</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>The role of our short-term trend following strategy is to balance our portfolio in case of any:</p>
                                        <ul>
                                            <li>Mega news events</li>
                                            <li>Financial statement surprises</li>
                                            <li>Unexpected sector rotations</li>
                                        </ul>
                                        <p class="mb-0">As shown in Figure 3, our PnL increases significantly when closing positions for mean reversion trades. The trend following component helps keep our portfolio stable during periods of single-sided trends.</p>
                                    </div>
                                    <div class="card-footer p-0">
                                        <div class="text-center p-3">
                                            <img src="/picture/image3.png" alt="Testing for SYF and COF" class="img-fluid rounded" onerror="this.onerror=null; this.src='https://via.placeholder.com/600x400?text=Mixed+Strategy+Visualization';">
                                            <p class="mt-2 text-muted small">Figure 3: Testing for SYF and COF (Purple is trend following, blue is long and red is short)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Blotter System -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Position Management</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>We trade every day when there is a signal, so our average price and position are updated and cumulative every day, just like real trading:</p>
                                        
                                        <pre class="bg-light p-3 rounded"><code>data.loc[data.index[i], f'{ticker1}_position'] = curr_position_ticker1 + ticker1_portion
                    data.loc[data.index[i], f'{ticker2}_position'] = curr_position_ticker2 - ticker2_portion
                    data.loc[data.index[i], f'{ticker1}_cost'] = update_cost(curr_position_ticker1, curr_cost_ticker1, ticker1_portion, price1)
                    data.loc[data.index[i], f'{ticker2}_cost'] = update_cost(curr_position_ticker2, curr_cost_ticker2, -ticker2_portion, price2)</code></pre>
                                        
                                        <p class="mb-0">This approach allows us to track the real performance of our strategy over time, accounting for the effects of averaging in and out of positions.</p>
                                    </div>
                                </div>
                                
                                <!-- Future Improvements -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Future Improvements</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <h5><i class="bi bi-lightbulb"></i> Key Enhancements</h5>
                                            <ol>
                                                <li>
                                                    <strong>Z-Score Enhancement:</strong>
                                                    <p>For some pairs, prices in the test timeframe may be significantly higher for both stocks, and our strategy cannot update the correct Z-score threshold even with rolling windows. A possible improvement would be using <strong>percentile for Z-score instead of fixed values</strong>.</p>
                                                </li>
                                                <li>
                                                    <strong>Volatility Management:</strong>
                                                    <p>Due to high volatility in 2025, unexpected portfolio losses may occur. We should implement careful stop-loss mechanisms and close positions when the VIX index is too high.</p>
                                                </li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>    

        
        <div class="row">
            <div class="col-md-6">
                <div class="stats-card">
                    <h4>Strategy Performance</h4>
                    <p>Alpha: <span id="sharpe-ratio" class="fw-bold">0.209</span></p>
                    <p>Beta: <span id="sharpe-ratio" class="fw-bold">-0.022</span></p>
                    <p>Geo mean Return: <span id="total-return" class="fw-bold">17.49%</span></p>
                    <p>Max Drawdown: <span id="max-drawdown" class="fw-bold">-4.79%</span></p>
                    <p>Sharpe Ratio: <span id="sharpe-ratio" class="fw-bold">1.4</span></p>
                    <p>Volatility: <span id="sharpe-ratio" class="fw-bold">0.23</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <h4>Trading Activity</h4>
                    <p>Average Return per Trade: <span id="mean-rev-trades" class="fw-bold">0.0078</span></p>
                    <p>Average Trades per Year: <span id="trend-trades" class="fw-bold">22.11</span></p>
                    <p>Total Trades: <span id="win-rate" class="fw-bold">21</span></p>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="price-tab" data-bs-toggle="tab" data-bs-target="#price" type="button" role="tab">Price & Spread</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="zscore-tab" data-bs-toggle="tab" data-bs-target="#zscore" type="button" role="tab">Z-Score & Signals</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button" role="tab">Portfolio Value</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button" role="tab">Positions</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Price & Spread Chart -->
            <div class="tab-pane fade show active" id="price" role="tabpanel">
                <!-- Add explanation section before charts -->
                <div class="strategy-explanation mb-4 p-3 border rounded bg-light">
                    <h4>Price and Spread Analysis</h4>
                    <p><strong>Strategy Overview:</strong> This pairs trading strategy combines mean reversion and trend-following approaches. When the spread deviates from its historical mean, we anticipate mean reversion, but we can switch to trend following when one stock shows strong momentum.</p>
                    <ul>
                        <li><strong>Price Chart</strong> - Shows price movements of LEVI and MHK stocks, highlighting their correlation patterns</li>
                        <li><strong>Spread Chart</strong> - Displays log-transformed LEVI-MHK spread for better stability and visualization of their relationship</li>
                        <li><strong>Trading Opportunities</strong> - Mean reversion opportunities emerge when the spread reaches extreme values, with momentum filtering for enhanced returns</li>
                    </ul>
                </div>
                <div id="price-chart" class="chart-container"></div>
                <div id="spread-chart" class="chart-container"></div>
            </div>
            
            <!-- Z-Score & Signals Chart -->
            <div class="tab-pane fade" id="zscore" role="tabpanel">
                <!-- Add explanation section before chart -->
                <div class="strategy-explanation mb-4 p-3 border rounded bg-light">
                    <h4>Z-Score and Trading Signals</h4>
                    <p><strong>Strategy Overview:</strong> Z-score standardizes the spread deviation from its mean. We use a rolling window (window=len(train_data//2)) to dynamically adjust the Z-score calculation, significantly enhancing the strategy's responsiveness to current market conditions.</p>
                    <ul>
                        <li><strong>Z-Score</strong> - Represents how many standard deviations the log spread is from its historical mean</li>
                        <li><strong>Trading Signals</strong> - Entry signals occur at Z-score thresholds of ±1.5, exit signals when Z-score approaches zero</li>
                        <li><strong>Hybrid Approach</strong> - Strategy switches to trend following when one stock shows strong momentum (10-day MA > 30-day MA and 5-day MA > 10-day MA)</li>
                    </ul>
                </div>
                <div id="zscore-chart" class="chart-container"></div>
            </div>
            
            <!-- Portfolio Value Chart -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
                <!-- Add explanation section before chart -->
                <div class="strategy-explanation mb-4 p-3 border rounded bg-light">
                    <h4>Portfolio Performance</h4>
                    <p><strong>Strategy Overview:</strong> Portfolio value reflects the overall performance of our hybrid strategy, which combines pairs trading (mean reversion) and short-term trend following to balance the portfolio during single-stock momentum periods.</p>
                    <ul>
                        <li><strong>Initial Investment</strong> - Starting with $100,000</li>
                        <li><strong>Value Fluctuations</strong> - Shows changes in portfolio value throughout strategy execution</li>
                        <li><strong>Strategy Switching</strong> - Notice stability during trend-following periods and significant gains when closing mean-reversion positions</li>
                    </ul>
                </div>
                <div id="portfolio-chart" class="chart-container"></div>
            </div>
            
            <!-- Positions Chart -->
            <div class="tab-pane fade" id="positions" role="tabpanel">
                <!-- Add explanation section before chart -->
                <div class="strategy-explanation mb-4 p-3 border rounded bg-light">
                    <h4>Position Management</h4>
                    <p><strong>Strategy Overview:</strong> Positions are balanced based on price magnitude differences between pairs to ensure market neutrality during mean-reversion strategies.</p>
                    <ul>
                        <li><strong>Price Ratio Allocation</strong> - Positions are sized according to price ratio: <code>ticker1_portion = int(100 * price1 / (price1 + price2))</code> to neutralize joint price movements</li>
                        <li><strong>Daily Position Updates</strong> - Positions are updated daily and cumulative, reflecting real trading conditions</li>
                        <li><strong>Strategy Switching</strong> - Positions can shift from balanced pairs to single-stock exposure during trend-following periods</li>
                    </ul>
                </div>
                <div id="positions-chart" class="chart-container"></div>
            </div>
        </div>
        <div class="col-md-12">
          <div class="card">
              <div class="card-header bg-light">
                  <h5 class="mb-0">Figure 4: Alpha and Beta Analysis</h5>
              </div>
              <div class="card-body text-center">
                  <img src="/picture/image4.png" alt="Spread after log transform" class="img-fluid rounded" onerror="this.onerror=null; this.src='https://via.placeholder.com/600x400?text=Log+Transform+Visualization';">
                  <p class="mt-3 text-muted small">The log-transformed spread provides clearer mean-reversion signals compared to raw price differences</p>
              </div>
          </div>
      </div>
        <h2 class="mt-5 mb-3">Trade History</h2>
        <ul class="nav nav-tabs" id="dataTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ledger-tab" data-bs-toggle="tab" data-bs-target="#ledger" type="button" role="tab">Ledger</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="blotter-tab" data-bs-toggle="tab" data-bs-target="#blotter" type="button" role="tab">Blotter</button>
            </li>
        </ul>
        
        <div class="tab-content" id="dataTabContent">
            <!-- Ledger Table -->
            <div class="tab-pane fade show active" id="ledger" role="tabpanel">
                <div class="table-responsive">
                    <table id="ledger-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Action</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Commission</th>
                                <th>Cash</th>
                                <th>Portfolio Value</th>
                                <th>Position</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Blotter Table -->
            <div class="tab-pane fade" id="blotter" role="tabpanel">
                <div class="table-responsive">
                    <table id="blotter-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Action</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Commission</th>
                                <th>Strategy</th>
                                <th>Z-Score</th>
                            </tr>
                        </thead>
                        <tbody id="blotter-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>   
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Sample data - Replace with actual data loading
        const ledgerData = [];  // Will be loaded from CSV
        const blotterData = []; // Will be loaded from CSV
        
        // Load data from CSV files
        async function loadData() {
            try {
                // Load ledger data
                const ledgerResponse = await fetch('../data/ledger_with_positions.csv');
                const ledgerText = await ledgerResponse.text();
                parseLedgerCSV(ledgerText);
                
                // Load blotter data
                const blotterResponse = await fetch('../data/blotter_converted.csv');
                const blotterText = await blotterResponse.text();
                parseBlotterCSV(blotterText);
                
                // Initialize charts and tables
                initCharts();
                initTables();
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }
        
        function parseLedgerCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n'); 
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                ledgerData.push(entry);
            }
            console.log("Parsed Ledger Data:", ledgerData);
        }
        
        function parseBlotterCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n'); 
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                blotterData.push(entry);
            }
        }
        
        function initCharts() {
            // Extract data for charts
            const dates = ledgerData.filter(d => d.ticker === 'LEVI').map(d => d.date);
            const leviPrices = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseFloat(d.price));
            const mhkPrices = ledgerData.filter(d => d.ticker === 'MHK').map(d => parseFloat(d.price));
            
            // Calculate spread
            const spread = leviPrices.map((levi, i) => levi - mhkPrices[i]);
            
            // Portfolio values
            const portfolioValues = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseFloat(d.portfolio_value));
            
            // Positions
            const leviPositions = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseFloat(d.position));
            const mhkPositions = ledgerData.filter(d => d.ticker === 'MHK').map(d => parseFloat(d.position));
            
            // Z-scores (from blotter)
            const zscores = blotterData.map(d => parseFloat(d.zscore));
            
            // Create Price chart
            Plotly.newPlot('price-chart', [
                {
                    x: dates,
                    y: leviPrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'LEVI',
                    line: { color: '#0066ff' },
                    hovertemplate: 'Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: mhkPrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MHK',
                    line: { color: '#ff6600' },
                    hovertemplate: 'Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Stock Prices',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Price ($)' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
            
            // Create Spread chart
            Plotly.newPlot('spread-chart', [
                {
                    x: dates,
                    y: spread,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'LEVI-MHK Spread',
                    line: { color: '#22cc22' },
                    hovertemplate: 'Date: %{x}<br>Spread: %{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Price Spread (LEVI - MHK)',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Spread' },
                hovermode: 'closest'
            });
            
            // Create Z-score chart with signals
            const buySignals = blotterData
                .filter(d => d.action === 'BUY')
                .map(d => ({
                    date: d.date,
                    zscore: parseFloat(d.zscore || 0),
                    strategy: d.strategy
                }));
                
            const sellSignals = blotterData
                .filter(d => d.action === 'SELL')
                .map(d => ({
                    date: d.date,
                    zscore: parseFloat(d.zscore || 0),
                    strategy: d.strategy
                }));
            
            Plotly.newPlot('zscore-chart', [
                {
                    x: dates,
                    y: zscores,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Z-Score',
                    line: { color: '#cc2222' },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<extra></extra>'
                },
                {
                    x: buySignals.map(s => s.date),
                    y: buySignals.map(s => s.zscore),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Buy Signals',
                    marker: { 
                        size: 10, 
                        color: 'green',
                        symbol: 'triangle-up'
                    },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<br>Action: Buy<br>Strategy: %{text}<extra></extra>',
                    text: buySignals.map(s => s.strategy)
                },
                {
                    x: sellSignals.map(s => s.date),
                    y: sellSignals.map(s => s.zscore),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Sell Signals',
                    marker: { 
                        size: 10, 
                        color: 'red',
                        symbol: 'triangle-down' 
                    },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<br>Action: Sell<br>Strategy: %{text}<extra></extra>',
                    text: sellSignals.map(s => s.strategy)
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [1.0, 1.0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Upper Threshold',
                    line: { color: 'rgba(0,128,0,0.5)', dash: 'dash' },
                    hoverinfo: 'none'
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [-1.0, -1.0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lower Threshold',
                    line: { color: 'rgba(0,128,0,0.5)', dash: 'dash' },
                    hoverinfo: 'none'
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [0, 0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Neutral',
                    line: { color: 'rgba(128,128,128,0.5)', dash: 'dot' },
                    hoverinfo: 'none'
                }
            ], {
                title: 'Z-Score and Trading Signals',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Z-Score' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
            
            // Create Portfolio Value chart
            Plotly.newPlot('portfolio-chart', [
                {
                    x: dates,
                    y: portfolioValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio Value',
                    line: { color: '#6600cc' },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(102, 0, 204, 0.1)',
                    hovertemplate: 'Date: %{x}<br>Value: $%{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Portfolio Value Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Value ($)' },
                hovermode: 'closest'
            });
            
            // Create Positions chart
            Plotly.newPlot('positions-chart', [
                {
                    x: dates,
                    y: leviPositions,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'LEVI Position',
                    line: { color: '#0066ff' },
                    hovertemplate: 'Date: %{x}<br>Position: %{y}<extra></extra>'
                },
                {
                    x: dates,
                    y: mhkPositions,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'MHK Position',
                    line: { color: '#ff6600' },
                    hovertemplate: 'Date: %{x}<br>Position: %{y}<extra></extra>'
                }
            ], {
                title: 'Stock Positions Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Position' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
        }
        
        function initTables() {
            // Populate Ledger table
            const ledgerBody = document.getElementById('ledger-body');
            ledgerData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.ticker}</td>
                    <td>${row.action}</td>
                    <td>$${parseFloat(row.price).toFixed(2)}</td>
                    <td>${row.quantity}</td>
                    <td>$${parseFloat(row.commission).toFixed(4)}</td>
                    <td>$${parseFloat(row.cash).toFixed(2)}</td>
                    <td>$${parseFloat(row.portfolio_value).toFixed(2)}</td>
                    <td>${parseInt(row.position)}</td>
                `;
                ledgerBody.appendChild(tr);
            });
            
            // Populate Blotter table
            const blotterBody = document.getElementById('blotter-body');
            blotterData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.ticker}</td>
                    <td>${row.action}</td>
                    <td>$${parseFloat(row.price).toFixed(2)}</td>
                    <td>${row.quantity}</td>
                    <td>$${parseFloat(row.commission).toFixed(4)}</td>
                    <td>${row.strategy || 'N/A'}</td>
                    <td>${parseFloat(row.zscore || 0).toFixed(2)}</td>
                `;
                blotterBody.appendChild(tr);
            });
            
            // Initialize DataTables
            $('#ledger-table').DataTable({
                order: [[0, 'desc']],
                pageLength: 15
            });
            
            $('#blotter-table').DataTable({
                order: [[0, 'desc']],
                pageLength: 15
            });
        }
        
        // Load data when the page is ready
        document.addEventListener('DOMContentLoaded', loadData);
        // Add to your existing loadData() function
        async function loadData() {
            try {
                // Load ledger data
                const ledgerResponse = await fetch('../data/final_ledger.csv');
                const ledgerText = await ledgerResponse.text();
                parseLedgerCSV(ledgerText);
                
                // Load blotter data
                const blotterResponse = await fetch('../data/blotter_converted.csv');
                const blotterText = await blotterResponse.text();
                parseBlotterCSV(blotterText);
                
                // Load validation data (if available)
                try {
                    const validationResponse = await fetch('../data/validate_pairs.csv');
                    const validationText = await validationResponse.text();
                    parseValidationCSV(validationText);
                } catch (e) {
                    // Use sample data if file not available
                    populateValidationTable(null);
                }
                
                // Initialize charts and tables
                initCharts();
                initTables();
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        // Add these new functions
        function parseValidationCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n'); 
            const headers = lines[0].split(',');
            const validationData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                validationData.push(entry);
            }
            
            populateValidationTable(validationData);
        }

        function populateValidationTable(data) {
            const tbody = document.getElementById('validation-body');
            if (!tbody) return; 

            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" class="text-center">Loading validation data...</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // 
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.ticker1}</td>
                    <td>${row.ticker2}</td>
                    <td>${parseFloat(row.coint_score).toFixed(3)}</td>
                    <td>${parseFloat(row.p_value).toExponential(3)}</td>
                    <td>${row.is_cointegrated === "True" ? 
                        '<span class="badge bg-success">Yes</span>' : 
                        '<span class="badge bg-secondary">No</span>'}</td>
                `;
                
                //LEVI-MHK 
                if ((row.ticker1 === 'LEVI' && row.ticker2 === 'MHK') || 
                    (row.ticker1 === 'MHK' && row.ticker2 === 'LEVI')) {
                    tr.classList.add('table-primary', 'fw-bold');
                }
                
                tbody.appendChild(tr);
            });

            if (!$.fn.DataTable.isDataTable('#validation-table')) {
                $('#validation-table').DataTable({
                    pageLength: 10,
                    order: [[2, 'asc']], 
                    language: {
                        search: "Filter pairs:"
                    }
                });
            }
        }
    </script>
</body>
</html>
