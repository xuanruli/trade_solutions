<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <title>Pairs Trading</title>
    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-2.26.2.min.js"></script>
    <!-- DataTables for interactive tables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #343a40;
        }
        .chart-container {
            height: 500px;
            margin-bottom: 30px;
        }
        .stats-card {
            background-color: #f1f8ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .tab-pane {
            padding: 20px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Pairs Trading Strategy Dashboard</h1>
        <p class="lead">Analysis and performance of LEVI-MHK pair trading strategy</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="stats-card">
                    <h4>Strategy Performance</h4>
                    <p>Total Return: <span id="total-return" class="fw-bold">12.5%</span></p>
                    <p>Max Drawdown: <span id="max-drawdown" class="fw-bold">-3.2%</span></p>
                    <p>Sharpe Ratio: <span id="sharpe-ratio" class="fw-bold">1.8</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <h4>Trading Activity</h4>
                    <p>Mean Reversion Trades: <span id="mean-rev-trades" class="fw-bold">24</span></p>
                    <p>Trend Following Trades: <span id="trend-trades" class="fw-bold">8</span></p>
                    <p>Win Rate: <span id="win-rate" class="fw-bold">68%</span></p>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="price-tab" data-bs-toggle="tab" data-bs-target="#price" type="button" role="tab">Price & Spread</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="zscore-tab" data-bs-toggle="tab" data-bs-target="#zscore" type="button" role="tab">Z-Score & Signals</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button" role="tab">Portfolio Value</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button" role="tab">Positions</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Price & Spread Chart -->
            <div class="tab-pane fade show active" id="price" role="tabpanel">
                <div id="price-chart" class="chart-container"></div>
                <div id="spread-chart" class="chart-container"></div>
            </div>
            
            <!-- Z-Score & Signals Chart -->
            <div class="tab-pane fade" id="zscore" role="tabpanel">
                <div id="zscore-chart" class="chart-container"></div>
            </div>
            
            <!-- Portfolio Value Chart -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
                <div id="portfolio-chart" class="chart-container"></div>
            </div>
            
            <!-- Positions Chart -->
            <div class="tab-pane fade" id="positions" role="tabpanel">
                <div id="positions-chart" class="chart-container"></div>
            </div>
        </div>
        
        <h2 class="mt-5 mb-3">Trade History</h2>
        <ul class="nav nav-tabs" id="dataTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ledger-tab" data-bs-toggle="tab" data-bs-target="#ledger" type="button" role="tab">Ledger</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="blotter-tab" data-bs-toggle="tab" data-bs-target="#blotter" type="button" role="tab">Blotter</button>
            </li>
        </ul>
        
        <div class="tab-content" id="dataTabContent">
            <!-- Ledger Table -->
            <div class="tab-pane fade show active" id="ledger" role="tabpanel">
                <div class="table-responsive">
                    <table id="ledger-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Action</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Commission</th>
                                <th>Cash</th>
                                <th>Portfolio Value</th>
                                <th>Position</th>
                                <th>Cumulative Position</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Blotter Table -->
            <div class="tab-pane fade" id="blotter" role="tabpanel">
                <div class="table-responsive">
                    <table id="blotter-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Action</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Commission</th>
                                <th>Strategy</th>
                                <th>Z-Score</th>
                            </tr>
                        </thead>
                        <tbody id="blotter-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Sample data - Replace with actual data loading
        const ledgerData = [];  // Will be loaded from CSV
        const blotterData = []; // Will be loaded from CSV
        
        // Load data from CSV files
        async function loadData() {
            try {
                // Load ledger data
                const ledgerResponse = await fetch('../data/ledger_with_positions.csv');
                const ledgerText = await ledgerResponse.text();
                parseLedgerCSV(ledgerText);
                
                // Load blotter data
                const blotterResponse = await fetch('../data/blotter_converted.csv');
                const blotterText = await blotterResponse.text();
                parseBlotterCSV(blotterText);
                
                // Initialize charts and tables
                initCharts();
                initTables();
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }
        
        function parseLedgerCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                ledgerData.push(entry);
            }
        }
        
        function parseBlotterCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                blotterData.push(entry);
            }
        }
        
        function initCharts() {
            // Extract data for charts
            const dates = ledgerData.filter(d => d.ticker === 'LEVI').map(d => d.date);
            const leviPrices = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseFloat(d.price));
            const mhkPrices = ledgerData.filter(d => d.ticker === 'MHK').map(d => parseFloat(d.price));
            
            // Calculate spread
            const spread = leviPrices.map((levi, i) => levi - mhkPrices[i]);
            
            // Portfolio values
            const portfolioValues = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseFloat(d.portfolio_value));
            
            // Positions
            const leviPositions = ledgerData.filter(d => d.ticker === 'LEVI').map(d => parseInt(d.cumulative_position));
            const mhkPositions = ledgerData.filter(d => d.ticker === 'MHK').map(d => parseInt(d.cumulative_position));
            
            // Z-scores (from blotter)
            const zscores = blotterData.map(d => parseFloat(d.zscore));
            
            // Create Price chart
            Plotly.newPlot('price-chart', [
                {
                    x: dates,
                    y: leviPrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'LEVI',
                    line: { color: '#0066ff' },
                    hovertemplate: 'Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: mhkPrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MHK',
                    line: { color: '#ff6600' },
                    hovertemplate: 'Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Stock Prices',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Price ($)' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
            
            // Create Spread chart
            Plotly.newPlot('spread-chart', [
                {
                    x: dates,
                    y: spread,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'LEVI-MHK Spread',
                    line: { color: '#22cc22' },
                    hovertemplate: 'Date: %{x}<br>Spread: %{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Price Spread (LEVI - MHK)',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Spread' },
                hovermode: 'closest'
            });
            
            // Create Z-score chart with signals
            const buySignals = blotterData
                .filter(d => d.action === 'BUY')
                .map(d => ({
                    date: d.date,
                    zscore: parseFloat(d.zscore || 0),
                    strategy: d.strategy
                }));
                
            const sellSignals = blotterData
                .filter(d => d.action === 'SELL')
                .map(d => ({
                    date: d.date,
                    zscore: parseFloat(d.zscore || 0),
                    strategy: d.strategy
                }));
            
            Plotly.newPlot('zscore-chart', [
                {
                    x: dates,
                    y: zscores,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Z-Score',
                    line: { color: '#cc2222' },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<extra></extra>'
                },
                {
                    x: buySignals.map(s => s.date),
                    y: buySignals.map(s => s.zscore),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Buy Signals',
                    marker: { 
                        size: 10, 
                        color: 'green',
                        symbol: 'triangle-up'
                    },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<br>Action: Buy<br>Strategy: %{text}<extra></extra>',
                    text: buySignals.map(s => s.strategy)
                },
                {
                    x: sellSignals.map(s => s.date),
                    y: sellSignals.map(s => s.zscore),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Sell Signals',
                    marker: { 
                        size: 10, 
                        color: 'red',
                        symbol: 'triangle-down' 
                    },
                    hovertemplate: 'Date: %{x}<br>Z-Score: %{y:.2f}<br>Action: Sell<br>Strategy: %{text}<extra></extra>',
                    text: sellSignals.map(s => s.strategy)
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [1.0, 1.0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Upper Threshold',
                    line: { color: 'rgba(0,128,0,0.5)', dash: 'dash' },
                    hoverinfo: 'none'
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [-1.0, -1.0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lower Threshold',
                    line: { color: 'rgba(0,128,0,0.5)', dash: 'dash' },
                    hoverinfo: 'none'
                },
                {
                    x: [dates[0], dates[dates.length-1]],
                    y: [0, 0],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Neutral',
                    line: { color: 'rgba(128,128,128,0.5)', dash: 'dot' },
                    hoverinfo: 'none'
                }
            ], {
                title: 'Z-Score and Trading Signals',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Z-Score' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
            
            // Create Portfolio Value chart
            Plotly.newPlot('portfolio-chart', [
                {
                    x: dates,
                    y: portfolioValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio Value',
                    line: { color: '#6600cc' },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(102, 0, 204, 0.1)',
                    hovertemplate: 'Date: %{x}<br>Value: $%{y:.2f}<extra></extra>'
                }
            ], {
                title: 'Portfolio Value Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Value ($)' },
                hovermode: 'closest'
            });
            
            // Create Positions chart
            Plotly.newPlot('positions-chart', [
                {
                    x: dates,
                    y: leviPositions,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'LEVI Position',
                    line: { color: '#0066ff' },
                    hovertemplate: 'Date: %{x}<br>Position: %{y}<extra></extra>'
                },
                {
                    x: dates,
                    y: mhkPositions,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'MHK Position',
                    line: { color: '#ff6600' },
                    hovertemplate: 'Date: %{x}<br>Position: %{y}<extra></extra>'
                }
            ], {
                title: 'Stock Positions Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Position' },
                hovermode: 'closest',
                legend: { orientation: 'h', y: 1.1 }
            });
        }
        
        function initTables() {
            // Populate Ledger table
            const ledgerBody = document.getElementById('ledger-body');
            ledgerData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.ticker}</td>
                    <td>${row.action}</td>
                    <td>$${parseFloat(row.price).toFixed(2)}</td>
                    <td>${row.quantity}</td>
                    <td>$${parseFloat(row.commission).toFixed(4)}</td>
                    <td>$${parseFloat(row.cash).toFixed(2)}</td>
                    <td>$${parseFloat(row.portfolio_value).toFixed(2)}</td>
                    <td>${row.position}</td>
                    <td>${row.cumulative_position}</td>
                `;
                ledgerBody.appendChild(tr);
            });
            
            // Populate Blotter table
            const blotterBody = document.getElementById('blotter-body');
            blotterData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.ticker}</td>
                    <td>${row.action}</td>
                    <td>$${parseFloat(row.price).toFixed(2)}</td>
                    <td>${row.quantity}</td>
                    <td>$${parseFloat(row.commission).toFixed(4)}</td>
                    <td>${row.strategy || 'N/A'}</td>
                    <td>${parseFloat(row.zscore || 0).toFixed(2)}</td>
                `;
                blotterBody.appendChild(tr);
            });
            
            // Initialize DataTables
            $('#ledger-table').DataTable({
                order: [[0, 'desc']],
                pageLength: 15
            });
            
            $('#blotter-table').DataTable({
                order: [[0, 'desc']],
                pageLength: 15
            });
        }
        
        // Load data when the page is ready
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>